generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql" // Ou sqlite para dev rápido inicial
  url      = env("DATABASE_URL")
}

enum Role {
  USER // Cliente final da clínica (paciente) - se tiver portal futuro
  MANAGER // Dono da clínica/Funcionário (Cliente do SaaS)
  ADMIN // Você (Super Admin do SaaS)
}

model User {
  id       String  @id @default(cuid())
  name     String?
  email    String  @unique
  password String?
  role     Role    @default(MANAGER)

  // --- NOVOS CAMPOS PARA O STRIPE & LIMITES ---
  plan                   Plan      @default(FREE)
  stripeCustomerId       String?   @unique // O ID do cliente no Stripe (cus_...)
  stripeSubscriptionId   String?   @unique // O ID da assinatura ativa (sub_...)
  stripePriceId          String? // Qual plano ele assina (price_...)
  stripeCurrentPeriodEnd DateTime? // Quando expira/renova
  isTrial                Boolean   @default(false)

  messageLimit Int @default(10) // Limite do plano (ex: 100, 300)
  messagesSent Int @default(0) // Contador de uso no ciclo atual
  // --------------------------------------------

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  waitlists   Waitlist[]
  patients    Patient[]
  agendaSlots AgendaSlot[]
}

model Patient {
  id    String  @id @default(cuid())
  name  String
  phone String // Essencial para o WhatsApp (Formato E.164 recomendado)
  email String?
  notes String? // Obs: "Prefere manhã", "Cliente VIP"

  managerId String
  manager   User   @relation(fields: [managerId], references: [id])

  entries WaitlistEntry[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Garante que o mesmo médico não cadastre o mesmo telefone 2x
  @@unique([managerId, phone])
}

model Waitlist {
  id          String  @id @default(cuid())
  name        String // Ex: "Dermatologia - Dra. Ana", "Cancelamentos Terça"
  description String?

  ownerId String
  owner   User   @relation(fields: [ownerId], references: [id])

  entries WaitlistEntry[]

  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model WaitlistEntry {
  id String @id @default(cuid())

  waitlistId String
  waitlist   Waitlist @relation(fields: [waitlistId], references: [id], onDelete: Cascade)

  patientId String
  patient   Patient @relation(fields: [patientId], references: [id], onDelete: Cascade)

  status EntryStatus @default(WAITING)

  // Para ordenação manual ou prioridade, se necessário. 
  // Por padrão usaremos addedAt (FIFO)
  priority Int @default(0)

  addedAt   DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([waitlistId, status])
}

model AgendaSlot {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  startTime DateTime
  endTime   DateTime

  isBooked Boolean @default(false) // Se o robô já preencheu essa vaga

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId, startTime])
}

enum EntryStatus {
  WAITING // Aguardando na fila
  NOTIFIED // O robô enviou a mensagem
  CONFIRMED // Encaixe realizado! (Vencedor)
  DECLINED // Paciente recusou
  EXPIRED // Tempo esgotou sem resposta
  CANCELED // Removido manualmente
}

enum Plan {
  FREE
  ESSENTIAL
  PRO
  PLUS
}
